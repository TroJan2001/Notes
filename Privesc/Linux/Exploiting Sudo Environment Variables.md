Sudo can be configured to inherit certain environment variables from the user's environment.
# Exploiting
### Method 1:  LD_PRELOAD using (preload.c)

Check which environment variables are inherited (look for the env_keep options):

```bash
sudo -l
```

LD_PRELOAD and LD_LIBRARY_PATH are both inherited from the user's environment. LD_PRELOAD loads a shared object before any others when a program is run. LD_LIBRARY_PATH provides a list of directories where shared libraries are searched for first.

Create a shared object using the code preload.c (in this example it is located at `/home/user/tools/sudo/preload.c`):

```bash
gcc -fPIC -shared -nostartfiles -o /tmp/preload.so /home/user/tools/sudo/preload.c
```

Run one of the programs you are allowed to run via sudo (listed when running **sudo -l**), while setting the LD_PRELOAD environment variable to the full path of the new shared object:

```bash
sudo LD_PRELOAD=/tmp/preload.so <program-name-here>
```
### Method 2:  LD_LIBRARY_PATH using (library.c)

Run ldd against the apache2 program file to see which shared libraries are used by the program, there is a reason why we chose apache2 command, because we can run it with sudo permissions without password need (run `sudo -l` to see which sudo commands you can run):

```bash
ldd /usr/sbin/apache2
```

Create a shared object with the same name as one of the listed libraries (libcrypt.so.1) using the code library.c (in this example it is located at ``/home/user/tools/sudo/library_path.c`):

```bash
gcc -o /tmp/libcrypt.so.1 -shared -fPIC /home/user/tools/sudo/library_path.c
```

Run apache2 using sudo, while settings the LD_LIBRARY_PATH environment variable to /tmp (where we output the compiled shared object):

```bash
sudo LD_LIBRARY_PATH=/tmp apache2
```

Note: when I tried the libpcre.so.3 library I got `undefined symbol: pcre_free` and for this one I found a solution which is adding a dummy code "void pcre_free(){} " to library.c code and it worked.